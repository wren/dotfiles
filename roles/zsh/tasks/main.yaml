- name: Ensure ZDOTDIR is defined in global zshenv
  lineinfile:
    path: /etc/zsh/zshenv
    line: ZDOTDIR="${HOME}/.config/zsh"
    state: present
    create: yes
  become: yes

- name: Install z-shell & friends
  loop:
    - zsh
    - exa
    - ripgrep
    - fd-find
    - lolcat
  apt:
    name: "{{ item }}"
    state: present
  become: yes

- name: Link fdfind -> fd
  file:
    src: "/bin/fdfind"
    dest: "/bin/fd"
    state: link
  become: true

- name: Install extras from homebrew
  homebrew:
    name:
      - sheldon
      # @TODO viu & vivid installs error out
      # - vivid
      # - viu
    state: present
    update_homebrew: false

- name: Check if vivid is installed
  check_mode: yes
  stat:
    path: /bin/vivid
  register: bin_vivid

- name: Install vivid
  apt:
    deb: https://github.com/sharkdp/vivid/releases/download/v0.8.0/vivid_0.8.0_amd64.deb
    state: present
  become: true
  when: not bin_vivid.stat.exists

- name: Create config dirs
  file:
    path: "{{ config_home }}/zsh"
    state: directory

- name: Create main dirs
  # zsh crashes without these (it's very annoying)
  loop:
    - "{{ data_home }}"
    - "{{ cache_home }}"
  file:
    path: "{{ item }}/zsh"
    state: directory

- name: Link main z-shell config file
  file:
    src: "{{ dotfiles_home }}/roles/zsh/files/_main.sh"
    dest: "{{ config_home }}/zsh/.zshrc"
    state: link

- file:
    src: "{{ dotfiles_home }}/roles/zsh/files/config/logout.sh"
    dest: "{{ config_home }}/zsh/.zlogout"
    state: link

- file:
    src: "{{ dotfiles_home }}/roles/zsh/files/motd.png"
    dest: "{{ config_home }}/zsh/motd.png"
    state: link

- name: Link other z-shell config files
  loop:
    - aliases
    - completion
    - env
    - keymap
    - motd
    - path
    - plugins
    - prompt
    - options
    - theme
    - xdg
  file:
    src: "{{ dotfiles_home }}/roles/zsh/files/config/{{ item }}.sh"
    dest: "{{ config_home }}/zsh/{{ item }}"
    state: link

- file:
    src: "{{ dotfiles_home }}/roles/zsh/files/env"
    dest: "{{ config_home }}/env/00_zsh.env.sh"
    state: link

- file:
    src: "{{ dotfiles_home }}/roles/zsh/files/functions"
    dest: "{{ config_home }}/zsh/functions"
    state: link

# --- Plugin manager --- #
- name: Creating plugin manager config dir
  file:
    path: "{{ config_home }}/sheldon"
    state: directory

- name: Linking plugin manager's config file
  file:
    src: "{{ dotfiles_home }}/roles/zsh/files/plugins.toml"
    dest: "{{ config_home }}/sheldon/plugins.toml"
    state: link

- name: Locking in shell plugins
  command: sheldon lock
  register: sheldon_output
  changed_when: "'CLONED' in sheldon_output.stderr"
